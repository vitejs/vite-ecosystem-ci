From 6cb4b354c6ed60a1711fa9d6c75b85b237f35c3a Mon Sep 17 00:00:00 2001
From: sapphi-red <49056869+sapphi-red@users.noreply.github.com>
Date: Wed, 5 Feb 2025 16:22:14 +0900
Subject: [PATCH] temporary commit

---
 integration/helpers/vite-5-template/vite.config.ts |  9 +++++++++
 integration/helpers/vite.ts                        | 11 +++++++++++
 integration/prefetch-test.ts                       | 12 ++++++------
 integration/vite-build-test.ts                     |  7 +++++++
 integration/vite-css-test.ts                       |  9 +++++++++
 integration/vite-dot-server-test.ts                |  6 +++---
 integration/vite-presets-test.ts                   | 11 +++++++++--
 packages/react-router-dev/vite/plugin.ts           |  1 +
 8 files changed, 55 insertions(+), 11 deletions(-)

diff --git a/integration/helpers/vite-5-template/vite.config.ts b/integration/helpers/vite-5-template/vite.config.ts
index fac933f..f80ea08 100644
--- a/integration/helpers/vite-5-template/vite.config.ts
+++ b/integration/helpers/vite-5-template/vite.config.ts
@@ -8,4 +8,13 @@ export default defineConfig({
     reactRouter(),
     tsconfigPaths(),
   ],
+  build: {
+    rollupOptions: {
+      // NOTE: ignore built-in minify under development warning
+      onwarn(warning, warn) {
+        if (warning.code === 'MINIFY_WARNING') return
+        warn(warning)
+      }
+    }
+  }
 });
diff --git a/integration/helpers/vite.ts b/integration/helpers/vite.ts
index 3c0d41b..43fb4ab 100644
--- a/integration/helpers/vite.ts
+++ b/integration/helpers/vite.ts
@@ -82,6 +82,17 @@ export const viteConfig = {
           envOnlyMacros(),
           tsconfigPaths()
         ],
+        build: {
+          rollupOptions: {
+            // NOTE: ignore missing export errors
+            shimMissingExports: true,
+            // NOTE: ignore built-in minify under development warning
+            onwarn(warning, warn) {
+              if (warning.code === 'MINIFY_WARNING') return
+              warn(warning)
+            }
+          }
+        }
       };
     `;
   },
diff --git a/integration/prefetch-test.ts b/integration/prefetch-test.ts
index 211030f..ac4d6a2 100644
--- a/integration/prefetch-test.ts
+++ b/integration/prefetch-test.ts
@@ -156,7 +156,7 @@ test.describe("prefetch=render", () => {
       { state: "attached" }
     );
     await page.waitForSelector(
-      "#nav link[rel='modulepreload'][href^='/assets/chunk-']",
+      "#nav link[rel='modulepreload'][href^='/assets/jsx-runtime-']",
       { state: "attached" }
     );
 
@@ -208,7 +208,7 @@ test.describe("prefetch=intent (hover)", () => {
       { state: "attached" }
     );
     await page.waitForSelector(
-      "#nav link[rel='modulepreload'][href^='/assets/chunk-']",
+      "#nav link[rel='modulepreload'][href^='/assets/jsx-runtime-']",
       { state: "attached" }
     );
     expect(await page.locator("#nav link").count()).toBe(4);
@@ -223,7 +223,7 @@ test.describe("prefetch=intent (hover)", () => {
       { state: "attached" }
     );
     await page.waitForSelector(
-      "#nav link[rel='modulepreload'][href^='/assets/chunk-']",
+      "#nav link[rel='modulepreload'][href^='/assets/jsx-runtime-']",
       { state: "attached" }
     );
     expect(await page.locator("#nav link").count()).toBe(3);
@@ -297,7 +297,7 @@ test.describe("prefetch=intent (focus)", () => {
       { state: "attached" }
     );
     await page.waitForSelector(
-      "#nav link[rel='modulepreload'][href^='/assets/chunk-']",
+      "#nav link[rel='modulepreload'][href^='/assets/jsx-runtime-']",
       { state: "attached" }
     );
     expect(await page.locator("#nav link").count()).toBe(4);
@@ -312,7 +312,7 @@ test.describe("prefetch=intent (focus)", () => {
       { state: "attached" }
     );
     await page.waitForSelector(
-      "#nav link[rel='modulepreload'][href^='/assets/chunk-']",
+      "#nav link[rel='modulepreload'][href^='/assets/jsx-runtime-']",
       { state: "attached" }
     );
     expect(await page.locator("#nav link").count()).toBe(3);
@@ -470,7 +470,7 @@ test.describe("other scenarios", () => {
     // We should not send a second request for this root stylesheet that's
     // already been rendered in the DOM
     let stylesheets = requests.filter(
-      (r) => r.type === "stylesheet" && /\/global-[a-z0-9]+\.css/i.test(r.url)
+      (r) => r.type === "stylesheet" && /\/global-[a-z0-9-]+\.css/i.test(r.url)
     );
     expect(stylesheets.length).toBe(1);
   });
diff --git a/integration/vite-build-test.ts b/integration/vite-build-test.ts
index 27d7ab5..3cfbda5 100644
--- a/integration/vite-build-test.ts
+++ b/integration/vite-build-test.ts
@@ -33,6 +33,13 @@ test.beforeAll(async () => {
         build: {
           // force emitting asset files instead of inlined as data-url
           assetsInlineLimit: 0,
+          // NOTE: ignore built-in minify under development warning
+          rollupOptions: {
+            onwarn(warning, warn) {
+              if (warning.code === 'MINIFY_WARNING') return
+              warn(warning)
+            }
+          }
         },
         plugins: [
           mdx(),
diff --git a/integration/vite-css-test.ts b/integration/vite-css-test.ts
index 296c0bd..bf4f843 100644
--- a/integration/vite-css-test.ts
+++ b/integration/vite-css-test.ts
@@ -163,6 +163,15 @@ const VITE_CONFIG = async (port: number) => dedent`
         emitCssInSsr: true,
       }),
     ],
+    build: {
+      rollupOptions: {
+        // NOTE: ignore built-in minify under development warning
+        onwarn(warning, warn) {
+          if (warning.code === 'MINIFY_WARNING') return
+          warn(warning)
+        }
+      }
+    }
   }
 `;
 
diff --git a/integration/vite-dot-server-test.ts b/integration/vite-dot-server-test.ts
index a4d6847..89996bd 100644
--- a/integration/vite-dot-server-test.ts
+++ b/integration/vite-dot-server-test.ts
@@ -139,12 +139,12 @@ test.describe("Vite / route / server-only module referenced by client", () => {
       [
         "Server-only module referenced by client",
 
-        `    '${specifier}' imported by route 'app/routes/_index.tsx'`,
+        /    '[^']+' imported by route 'app\/routes\/_index\.tsx'/, // NOTE: specifier may be raw or resolved
 
         "  React Router automatically removes server-code from these exports:",
         "    `loader`, `action`, `headers`",
 
-        `  But other route exports in 'app/routes/_index.tsx' depend on '${specifier}'.`,
+        /  But other route exports in 'app\/routes\/_index\.tsx' depend on '[^']+'\./, // NOTE: specifier may be raw or resolved
 
         "  See https://remix.run/docs/en/main/guides/vite#splitting-up-client-and-server-code",
       ].forEach(expect(stderr).toMatch);
@@ -204,7 +204,7 @@ test.describe("Vite / non-route / server-only module referenced by client", () =
       [
         `Server-only module referenced by client`,
 
-        `    '${specifier}' imported by 'app/reexport-server-only.ts'`,
+        /    '[^']+' imported by 'app\/reexport-server-only\.ts'/, // NOTE: specifier may be raw or resolved
 
         "  See https://remix.run/docs/en/main/guides/vite#splitting-up-client-and-server-code",
       ].forEach(expect(stderr).toMatch);
diff --git a/integration/vite-presets-test.ts b/integration/vite-presets-test.ts
index 12ea017..e43b4c3 100644
--- a/integration/vite-presets-test.ts
+++ b/integration/vite-presets-test.ts
@@ -23,7 +23,7 @@ const files = {
     export default {
       // Ensure user config takes precedence over preset config
       appDirectory: "app",
-      
+
       presets: [
         // Ensure user config is passed to reactRouterConfig hook
         {
@@ -137,8 +137,15 @@ const files = {
     export default {
       build: {
         assetsDir: "custom-assets-dir",
+        rollupOptions: {
+          // NOTE: ignore built-in minify under development warning
+          onwarn(warning: any, warn: any) {
+            if (warning.code === 'MINIFY_WARNING') return
+            warn(warning)
+          }
+        }
       },
-      plugins: [reactRouter()],
+      plugins: [reactRouter()]
     }
   `),
 };
diff --git a/packages/react-router-dev/vite/plugin.ts b/packages/react-router-dev/vite/plugin.ts
index 1ba82a9..8905659 100644
--- a/packages/react-router-dev/vite/plugin.ts
+++ b/packages/react-router-dev/vite/plugin.ts
@@ -2714,6 +2714,7 @@ export async function getEnvironmentOptionsResolvers(
       cssMinify: viteUserConfig.build?.cssMinify ?? true,
       manifest: true, // The manifest is enabled for all builds to detect SSR-only assets
       rollupOptions: {
+        // @ts-expect-error rolldown does not support `preserveEntrySignatures` yet
         preserveEntrySignatures: "exports-only",
         // Silence Rollup "use client" warnings
         // Adapted from https://github.com/vitejs/vite-plugin-react/pull/144
-- 
2.47.1

