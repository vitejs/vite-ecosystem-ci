From e8eeb500c176ffc273af3f9813e9f41238a2bf5a Mon Sep 17 00:00:00 2001
From: sapphi-red <49056869+sapphi-red@users.noreply.github.com>
Date: Tue, 22 Apr 2025 16:22:27 +0900
Subject: [PATCH] temporary commit

---
 .../__tests__/assets-importing-from-dependencies.spec.ts    | 2 +-
 packages/vite-plugin-cloudflare/playground/vitest-setup.ts  | 6 ++++++
 packages/vite-plugin-cloudflare/src/index.ts                | 3 ++-
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/packages/vite-plugin-cloudflare/playground/deps-assets-importing/__tests__/assets-importing-from-dependencies.spec.ts b/packages/vite-plugin-cloudflare/playground/deps-assets-importing/__tests__/assets-importing-from-dependencies.spec.ts
index f500614..6a224d5 100644
--- a/packages/vite-plugin-cloudflare/playground/deps-assets-importing/__tests__/assets-importing-from-dependencies.spec.ts
+++ b/packages/vite-plugin-cloudflare/playground/deps-assets-importing/__tests__/assets-importing-from-dependencies.spec.ts
@@ -3,6 +3,6 @@ import { getTextResponse } from "../../__test-utils__";
 
 test("it is possible to import assets from dependencies", async () => {
 	expect(await getTextResponse()).toMatch(
-		/Hello! This is an application built using vite@[^ ]+? \(information retrieved from "[^"]+?\.json"\)/
+		/Hello! This is an application built using (?:rolldown-)?vite@[^ ]+? \(information retrieved from "[^"]+?\.json"\)/
 	);
 });
diff --git a/packages/vite-plugin-cloudflare/playground/vitest-setup.ts b/packages/vite-plugin-cloudflare/playground/vitest-setup.ts
index c14ff81..71fd35f 100644
--- a/packages/vite-plugin-cloudflare/playground/vitest-setup.ts
+++ b/packages/vite-plugin-cloudflare/playground/vitest-setup.ts
@@ -337,6 +337,12 @@ export function createInMemoryLogger(
 			info.push(msg);
 		},
 		warn(msg) {
+			// mute warning temporary for now
+			if (
+				msg.includes('optimizeDeps.esbuildOptions') ||
+				msg.includes('built-in minifier')
+			) return;
+
 			warns.push(msg);
 			logger.hasWarned = true;
 		},
diff --git a/packages/vite-plugin-cloudflare/src/index.ts b/packages/vite-plugin-cloudflare/src/index.ts
index 1f56110..a753101 100644
--- a/packages/vite-plugin-cloudflare/src/index.ts
+++ b/packages/vite-plugin-cloudflare/src/index.ts
@@ -553,12 +553,13 @@ export function cloudflare(pluginConfig: PluginConfig = {}): vite.Plugin[] {
 						build: {
 							rollupOptions: {
 								plugins: [
+									// rolldown type incompat
 									replace({
 										"process.env.NODE_ENV": JSON.stringify(
 											process.env.NODE_ENV ?? "production"
 										),
 										preventAssignment: true,
-									}),
+									}) as any,
 								],
 							},
 						},
-- 
2.48.1

