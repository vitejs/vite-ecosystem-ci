From 141a77f4a05b704fc37846428ab9b4492f9b3193 Mon Sep 17 00:00:00 2001
From: sapphi-red <49056869+sapphi-red@users.noreply.github.com>
Date: Wed, 29 Jan 2025 14:49:27 +0900
Subject: [PATCH] temporary commit

---
 .../src/adapters/shared/vite/index.ts         |  2 +-
 .../qwik-city/src/buildtime/vite/plugin.ts    |  2 +-
 .../qwik/src/optimizer/src/plugins/plugin.ts  | 22 ++++++++--------
 .../qwik/src/optimizer/src/plugins/rollup.ts  | 26 ++++++++++---------
 .../qwik/src/optimizer/src/plugins/vite.ts    | 18 ++++++++-----
 starters/features/storybook/tsconfig.json     |  3 +++
 6 files changed, 41 insertions(+), 32 deletions(-)
 create mode 100644 starters/features/storybook/tsconfig.json

diff --git a/packages/qwik-city/src/adapters/shared/vite/index.ts b/packages/qwik-city/src/adapters/shared/vite/index.ts
index 9fb056d..41e1a86 100644
--- a/packages/qwik-city/src/adapters/shared/vite/index.ts
+++ b/packages/qwik-city/src/adapters/shared/vite/index.ts
@@ -106,7 +106,7 @@ export function viteAdapter(opts: ViteAdapterPluginOptions) {
     },
 
     closeBundle: {
-      sequential: true,
+      // sequential: true,
       async handler() {
         if (
           isSsrBuild &&
diff --git a/packages/qwik-city/src/buildtime/vite/plugin.ts b/packages/qwik-city/src/buildtime/vite/plugin.ts
index b7ac8db..1952ccd 100644
--- a/packages/qwik-city/src/buildtime/vite/plugin.ts
+++ b/packages/qwik-city/src/buildtime/vite/plugin.ts
@@ -260,7 +260,7 @@ function qwikCityPlugin(userOpts?: QwikCityVitePluginOptions): any {
     },
 
     closeBundle: {
-      sequential: true,
+      // sequential: true,
       async handler() {
         if (ctx?.target === 'ssr' && !ctx?.isDevServer) {
           // ssr build
diff --git a/packages/qwik/src/optimizer/src/plugins/plugin.ts b/packages/qwik/src/optimizer/src/plugins/plugin.ts
index 02e9acd..7193a5f 100644
--- a/packages/qwik/src/optimizer/src/plugins/plugin.ts
+++ b/packages/qwik/src/optimizer/src/plugins/plugin.ts
@@ -605,7 +605,7 @@ export function createPlugin(optimizerOptions: OptimizerOptions = {}) {
     ctx: Rollup.PluginContext,
     code: string,
     id: string,
-    transformOpts: Parameters<Extract<Plugin['transform'], Function>>[2] = {}
+    transformOpts: Partial<Parameters<Extract<Plugin['transform'], Function>>[2]> = {}
   ): Promise<TransformResult> {
     if (id.startsWith('\0')) {
       return;
@@ -721,7 +721,8 @@ export function createPlugin(optimizerOptions: OptimizerOptions = {}) {
               ctx.emitFile({
                 id: key,
                 type: 'chunk',
-                preserveSignature: 'allow-extension',
+                // NOTE: rolldown does not support preserveSignature
+                // preserveSignature: 'allow-extension',
               });
             }
           }
@@ -732,9 +733,8 @@ export function createPlugin(optimizerOptions: OptimizerOptions = {}) {
       // unchanged imports are not missing in our internal transform cache
       // This can happen in the repl when the plugin is re-initialized
       // and possibly in other places
-      for (const id of deps.values()) {
-        await ctx.load({ id });
-      }
+      // NOTE: this should be Promise.all rather than a for-loop to avoid deadlocks
+      await Promise.all([...deps.values()].map(id => ctx.load({ id })))
 
       ctx.addWatchFile(id);
 
@@ -873,11 +873,11 @@ export const manifest = ${JSON.stringify(manifest)};\n`;
   // This groups all QRL segments into their respective entry points
   // optimization opportunity: group small segments that don't import anything into smallish chunks
   // order by discovery time, so that related segments are more likely to group together
-  function manualChunks(id: string, { getModuleInfo }: Rollup.ManualChunkMeta) {
-    const module = getModuleInfo(id)!;
-    const segment = module.meta.segment as SegmentAnalysis | undefined;
-    return segment?.entry;
-  }
+  // function manualChunks(id: string, { getModuleInfo }: Rollup.ManualChunkMeta) {
+  //   const module = getModuleInfo(id)!;
+  //   const segment = module.meta.segment as SegmentAnalysis | undefined;
+  //   return segment?.entry;
+  // }
 
   return {
     buildStart,
@@ -901,7 +901,7 @@ export const manifest = ${JSON.stringify(manifest)};\n`;
     setSourceMapSupport,
     configureServer,
     handleHotUpdate,
-    manualChunks,
+    // manualChunks,
   };
 }
 
diff --git a/packages/qwik/src/optimizer/src/plugins/rollup.ts b/packages/qwik/src/optimizer/src/plugins/rollup.ts
index 0438aec..908f0a3 100644
--- a/packages/qwik/src/optimizer/src/plugins/rollup.ts
+++ b/packages/qwik/src/optimizer/src/plugins/rollup.ts
@@ -81,7 +81,7 @@ export function qwikRollup(qwikRollupOpts: QwikRollupPluginOptions = {}): any {
         qwikPlugin.getOptions(),
         rollupOutputOpts,
         false,
-        qwikPlugin.manualChunks
+        // qwikPlugin.manualChunks
       );
     },
 
@@ -100,6 +100,7 @@ export function qwikRollup(qwikRollupOpts: QwikRollupPluginOptions = {}): any {
       await qwikPlugin.buildStart(this);
     },
 
+    // @ts-expect-error rolldown type incompat
     resolveId(id, importer) {
       if (id.startsWith('\0')) {
         return null;
@@ -127,6 +128,7 @@ export function qwikRollup(qwikRollupOpts: QwikRollupPluginOptions = {}): any {
       if (opts.target === 'client') {
         // client build
         const optimizer = qwikPlugin.getOptimizer();
+        // @ts-expect-error rolldown type incompat
         const outputAnalyzer = qwikPlugin.createOutputAnalyzer(rollupBundle);
         const manifest = await outputAnalyzer.generateManifest();
         manifest.platform = {
@@ -163,7 +165,7 @@ export function normalizeRollupOutputOptions(
   opts: NormalizedQwikPluginOptions,
   rollupOutputOpts: Rollup.OutputOptions | Rollup.OutputOptions[] | undefined,
   useAssetsDir: boolean,
-  manualChunks: Rollup.GetManualChunk,
+  // manualChunks: Rollup.GetManualChunk,
   outDir?: string
 ): Rollup.OutputOptions | Rollup.OutputOptions[] {
   if (Array.isArray(rollupOutputOpts)) {
@@ -173,13 +175,13 @@ export function normalizeRollupOutputOptions(
     }
 
     return rollupOutputOpts.map((outputOptsObj) => ({
-      ...normalizeRollupOutputOptionsObject(opts, outputOptsObj, useAssetsDir, manualChunks),
+      ...normalizeRollupOutputOptionsObject(opts, outputOptsObj, useAssetsDir),
       dir: outDir || outputOptsObj.dir,
     }));
   }
 
   return {
-    ...normalizeRollupOutputOptionsObject(opts, rollupOutputOpts, useAssetsDir, manualChunks),
+    ...normalizeRollupOutputOptionsObject(opts, rollupOutputOpts, useAssetsDir),
     dir: outDir || rollupOutputOpts?.dir,
   };
 }
@@ -188,7 +190,7 @@ export function normalizeRollupOutputOptionsObject(
   opts: NormalizedQwikPluginOptions,
   rollupOutputOptsObj: Rollup.OutputOptions | undefined,
   useAssetsDir: boolean,
-  manualChunks: Rollup.GetManualChunk
+  // manualChunks: Rollup.GetManualChunk
 ): Rollup.OutputOptions {
   const outputOpts: Rollup.OutputOptions = { ...rollupOutputOptsObj };
 
@@ -225,13 +227,13 @@ export function normalizeRollupOutputOptionsObject(
   if (opts.target === 'client') {
     // client should always be es
     outputOpts.format = 'es';
-    const prevManualChunks = outputOpts.manualChunks;
-    if (prevManualChunks && typeof prevManualChunks !== 'function') {
-      throw new Error('manualChunks must be a function');
-    }
-    outputOpts.manualChunks = prevManualChunks
-      ? (id, meta) => prevManualChunks(id, meta) || manualChunks(id, meta)
-      : manualChunks;
+    // const prevManualChunks = outputOpts.manualChunks;
+    // if (prevManualChunks && typeof prevManualChunks !== 'function') {
+    //   throw new Error('manualChunks must be a function');
+    // }
+    // outputOpts.manualChunks = prevManualChunks
+    //   ? (id, meta) => prevManualChunks(id, meta) || manualChunks(id, meta)
+    //   : manualChunks;
   }
 
   if (!outputOpts.dir) {
diff --git a/packages/qwik/src/optimizer/src/plugins/vite.ts b/packages/qwik/src/optimizer/src/plugins/vite.ts
index 158188f..9488232 100644
--- a/packages/qwik/src/optimizer/src/plugins/vite.ts
+++ b/packages/qwik/src/optimizer/src/plugins/vite.ts
@@ -334,11 +334,12 @@ export function qwikVite(qwikViteOpts: QwikVitePluginOptions = {}): any {
           dynamicImportVarsOptions: {
             exclude: [/./],
           },
-          rollupOptions: {
-            output: {
-              manualChunks: qwikPlugin.manualChunks,
-            },
-          },
+          // NOTE: rolldown does not support manualChunks
+          // rollupOptions: {
+          //   output: {
+          //     manualChunks: qwikPlugin.manualChunks,
+          //   },
+          // },
         },
         define: {
           [qDevKey]: qDev,
@@ -363,10 +364,11 @@ export function qwikVite(qwikViteOpts: QwikVitePluginOptions = {}): any {
             opts,
             viteConfig.build?.rollupOptions?.output,
             useAssetsDir,
-            qwikPlugin.manualChunks,
+            // qwikPlugin.manualChunks,
             buildOutputDir
           ),
-          preserveEntrySignatures: 'exports-only',
+          // NOTE: rolldown does not support preserveEntrySignatures
+          // preserveEntrySignatures: 'exports-only',
           onwarn: (warning, warn) => {
             if (warning.plugin === 'typescript' && warning.message.includes('outputToFilesystem')) {
               return;
@@ -467,6 +469,7 @@ export function qwikVite(qwikViteOpts: QwikVitePluginOptions = {}): any {
       await qwikPlugin.buildStart(this);
     },
 
+    // @ts-expect-error rolldown type incompat
     resolveId(id, importer, resolveIdOpts) {
       if (id.startsWith('\0') || !fileFilter(id, 'resolveId')) {
         return null;
@@ -522,6 +525,7 @@ export function qwikVite(qwikViteOpts: QwikVitePluginOptions = {}): any {
 
         if (opts.target === 'client') {
           // client build
+          // @ts-expect-error rolldown type incompat
           const outputAnalyzer = qwikPlugin.createOutputAnalyzer(rollupBundle);
 
           for (const [fileName, b] of Object.entries(rollupBundle)) {
diff --git a/starters/features/storybook/tsconfig.json b/starters/features/storybook/tsconfig.json
new file mode 100644
index 0000000..d10ac0d
--- /dev/null
+++ b/starters/features/storybook/tsconfig.json
@@ -0,0 +1,3 @@
+{
+  "//": "empty for workaround"
+}
-- 
2.47.1

