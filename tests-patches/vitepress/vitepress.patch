From 9a34c0b3555d2389569c74cfb406d68741b2e579 Mon Sep 17 00:00:00 2001
From: sapphi-red <49056869+sapphi-red@users.noreply.github.com>
Date: Wed, 22 Jan 2025 11:37:42 +0900
Subject: [PATCH] temporary commit

---
 package.json       |  2 +-
 rollup.config.ts   | 72 +++++++++++++++++++++++-----------------------
 src/node/plugin.ts | 23 +++++++++------
 3 files changed, 52 insertions(+), 45 deletions(-)

diff --git a/package.json b/package.json
index a488b4a..90bc3cc 100644
--- a/package.json
+++ b/package.json
@@ -60,7 +60,7 @@
     "build": "pnpm build:prepare && pnpm build:client && pnpm build:node",
     "build:prepare": "rimraf dist && node scripts/copyShared",
     "build:client": "vue-tsc --noEmit -p src/client && tsc -p src/client && node scripts/copyClient",
-    "build:node": "tsc -p src/node --noEmit && rollup --config rollup.config.ts --configPlugin esbuild",
+    "build:node": "rollup --config rollup.config.ts --configPlugin esbuild",
     "test": "pnpm --aggregate-output --reporter=append-only '/^test:(unit|e2e|init)$/'",
     "test:unit": "vitest run -r __tests__/unit",
     "test:unit:watch": "vitest -r __tests__/unit",
diff --git a/rollup.config.ts b/rollup.config.ts
index 8a996b0..cff0866 100644
--- a/rollup.config.ts
+++ b/rollup.config.ts
@@ -14,7 +14,7 @@ const require = createRequire(import.meta.url)
 const pkg = require('./package.json')
 
 const DEV = !!process.env.DEV
-const PROD = !DEV
+// const PROD = !DEV
 
 const external = [
   ...Object.keys(pkg.dependencies),
@@ -58,12 +58,12 @@ const esmBuild: RollupOptions = {
   }
 }
 
-const typesExternal = [
-  ...external,
-  /\/vitepress\/(?!(dist|node_modules)\/).*\.d\.ts$/,
-  'source-map-js',
-  'fast-glob'
-]
+// const typesExternal = [
+//   ...external,
+//   /\/vitepress\/(?!(dist|node_modules)\/).*\.d\.ts$/,
+//   'source-map-js',
+//   'fast-glob'
+// ]
 
 const dtsNode = dts({
   respectExternal: true,
@@ -78,34 +78,34 @@ dtsNode.resolveId = async function (source, importer) {
   return res
 }
 
-const nodeTypes: RollupOptions = {
-  input: 'src/node/index.ts',
-  output: {
-    format: 'esm',
-    file: 'dist/node/index.d.ts'
-  },
-  external: typesExternal,
-  plugins: [dtsNode]
-}
+// const nodeTypes: RollupOptions = {
+//   input: 'src/node/index.ts',
+//   output: {
+//     format: 'esm',
+//     file: 'dist/node/index.d.ts'
+//   },
+//   external: typesExternal,
+//   plugins: [dtsNode]
+// }
 
-const clientTypes: RollupOptions = {
-  input: 'dist/client-types/index.d.ts',
-  output: {
-    format: 'esm',
-    file: 'dist/client/index.d.ts'
-  },
-  external: typesExternal,
-  plugins: [
-    dts({ respectExternal: true }),
-    {
-      name: 'cleanup',
-      async closeBundle() {
-        if (PROD) {
-          await fs.rm('dist/client-types', { recursive: true })
-        }
-      }
-    }
-  ]
-}
+// const clientTypes: RollupOptions = {
+//   input: 'dist/client-types/index.d.ts',
+//   output: {
+//     format: 'esm',
+//     file: 'dist/client/index.d.ts'
+//   },
+//   external: typesExternal,
+//   plugins: [
+//     dts({ respectExternal: true }),
+//     {
+//       name: 'cleanup',
+//       async closeBundle() {
+//         if (PROD) {
+//           await fs.rm('dist/client-types', { recursive: true })
+//         }
+//       }
+//     }
+//   ]
+// }
 
-export default defineConfig([esmBuild, nodeTypes, clientTypes])
+export default defineConfig([esmBuild /*, nodeTypes, clientTypes */])
diff --git a/src/node/plugin.ts b/src/node/plugin.ts
index 27c8552..f8da6e1 100644
--- a/src/node/plugin.ts
+++ b/src/node/plugin.ts
@@ -352,15 +352,22 @@ export async function createVitePressPlugin(
             pageToHashMap![chunk.name.toLowerCase()] = hash
 
             // inject another chunk with the content stripped
-            bundle[name + '-lean'] = {
-              ...chunk,
+            this.emitFile({
+              type: 'asset',
+              name: name + '-lean',
               fileName: chunk.fileName.replace(/\.js$/, '.lean.js'),
-              preliminaryFileName: chunk.preliminaryFileName.replace(
-                /\.js$/,
-                '.lean.js'
-              ),
-              code: chunk.code.replace(staticStripRE, `""`)
-            }
+              source: chunk.code.replace(staticStripRE, `""`)
+            })
+            // NOTE: assigning to bundle[foo] is not supported by Rolldown and is discouraged by Rollup
+            // bundle[name + '-lean'] = {
+            //   ...chunk,
+            //   fileName: chunk.fileName.replace(/\.js$/, '.lean.js'),
+            //   preliminaryFileName: chunk.preliminaryFileName.replace(
+            //     /\.js$/,
+            //     '.lean.js'
+            //   ),
+            //   code: chunk.code.replace(staticStripRE, `""`)
+            // }
 
             // remove static markers from original code
             chunk.code = chunk.code.replace(staticRestoreRE, '')
-- 
2.47.1

