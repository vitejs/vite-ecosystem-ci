From b70a5d3228b5eafd9e11aa69eb53d92c1ab08688 Mon Sep 17 00:00:00 2001
From: sapphi-red <49056869+sapphi-red@users.noreply.github.com>
Date: Sat, 12 Apr 2025 19:47:42 +0900
Subject: [PATCH] temporary commit

---
 .../exports/vite/graph_analysis/index.spec.js    |  1 -
 packages/kit/src/exports/vite/index.js           | 16 ++++++++++++----
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/packages/kit/src/exports/vite/graph_analysis/index.spec.js b/packages/kit/src/exports/vite/graph_analysis/index.spec.js
index 35ecd31..4617849 100644
--- a/packages/kit/src/exports/vite/graph_analysis/index.spec.js
+++ b/packages/kit/src/exports/vite/graph_analysis/index.spec.js
@@ -8,7 +8,6 @@ import * as module_ids from '../module_ids.js';
  * @param {string} [expected_error]
  */
 function check(graph, expected_error) {
-	// @ts-expect-error
 	const context = /** @type {import('vite').Rollup.PluginContext} */ ({
 		/** @param {string} id */
 		getModuleInfo(id) {
diff --git a/packages/kit/src/exports/vite/index.js b/packages/kit/src/exports/vite/index.js
index c2e445e..1b1cafd 100644
--- a/packages/kit/src/exports/vite/index.js
+++ b/packages/kit/src/exports/vite/index.js
@@ -673,12 +673,18 @@ Tips:
 								entryFileNames: ssr ? '[name].js' : `${prefix}/[name].[hash].${ext}`,
 								chunkFileNames: ssr ? 'chunks/[name].js' : `${prefix}/chunks/[hash].${ext}`,
 								assetFileNames: `${prefix}/assets/[name].[hash][extname]`,
+								// @ts-expect-error rolldown does not support `hoistTransitiveImports` option
 								hoistTransitiveImports: false,
 								sourcemapIgnoreList,
-								manualChunks: split ? undefined : () => 'bundle',
-								inlineDynamicImports: false
+								// NOTE: rolldown does not support manualChunks option
+								// manualChunks: split ? undefined : () => 'bundle',
+								inlineDynamicImports: split ? false : true
 							},
 							preserveEntrySignatures: 'strict',
+							experimental: {
+								// NOTE: so that inlineDynamicImports does not break the execution order
+								strictExecutionOrder: split ? undefined : true
+							},
 							onwarn(warning, handler) {
 								if (
 									warning.code === 'MISSING_EXPORT' &&
@@ -702,6 +708,7 @@ Tips:
 								entryFileNames: `${prefix}/workers/[name]-[hash].js`,
 								chunkFileNames: `${prefix}/workers/chunks/[hash].js`,
 								assetFileNames: `${prefix}/workers/assets/[name]-[hash][extname]`,
+								// @ts-expect-error rolldown does not support `hoistTransitiveImports` option
 								hoistTransitiveImports: false
 							}
 						}
@@ -750,6 +757,7 @@ Tips:
 			if (secondary_build_started) return;
 
 			if (is_build) {
+				// @ts-expect-error rolldown-vite does not support `watch` yet
 				if (!vite_config.build.watch) {
 					rimraf(out);
 				}
@@ -760,7 +768,7 @@ Tips:
 		renderChunk(code, chunk) {
 			if (code.includes('__SVELTEKIT_TRACK__')) {
 				return {
-					code: code.replace(/__SVELTEKIT_TRACK__\('(.+?)'\)/g, (_, label) => {
+					code: code.replace(/__SVELTEKIT_TRACK__\(['"](.+?)['"]\)/g, (_, label) => {
 						(tracked_features[chunk.name + '.js'] ??= []).push(label);
 						// put extra whitespace at the end of the comment to preserve the source size and avoid interfering with source maps
 						return `/* track ${label}            */`;
@@ -852,7 +860,7 @@ Tips:
 
 				secondary_build_started = true;
 
-				const { output } = /** @type {import('vite').Rollup.RollupOutput} */ (
+				const { output } = /** @type {import('vite').Rollup.RolldownOutput} */ (
 					await vite.build({
 						configFile: vite_config.configFile,
 						// CLI args
-- 
2.48.1

